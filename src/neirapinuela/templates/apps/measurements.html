{% extends "base.html" %}

{% block title %}
{{ _('Conversor de Unidades') }}
{% endblock %}

{% block content %}
<h1>{{ _('Conversor de Unidades') }}</h1>

<div class="row mb-4">
    <div class="col-md-6">
        <label class="form-label">{{ _('Selecciona el tipo de unidad:') }}</label>
        <select class="form-select measurement_selector" onchange="if (this.value) window.location.href=this.value">
            {% for k in kinds %}
            <option value="{{ url_for("apps.measurements", kind=k) }}" {% if k==kind %}selected{% endif %}>
                {{ translate_kinds[k] }}</option>
            {% endfor %}
        </select>
    </div>
</div>

{% set extra_cols = 2 %}
<div class="table-responsive mb-4">
    <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
            <tr>
                {% for col in range(extra_cols) %}
                <th scope="col" style="width: 5%"></th>
                {% endfor %}
                {% for unit in units %}
                <th scope="col" class="fw-bold">{{ unit }}</th>
                {% endfor %}
                {% for col in range(extra_cols) %}
                <th scope="col" style="width: 5%"></th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                {% for _ in range(units|length + extra_cols * 2) %}
                <td class="p-1">
                    <select class="form-select form-select-sm unit_selector text-center">
                        <option></option>
                        {% for option in range(10) %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
</div>

<div class="row align-items-center mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h4 class="mb-0">
                    {{ _('Convierte %(qty)s %(orig_unit)s a %(dest_unit)s',
                    qty='<span id="question" class="fw-bold text-primary"></span>'|safe,
                    orig_unit='<span id="orig_unit" class="fw-bold"></span>'|safe,
                    dest_unit='<span id="dest_unit1" class="fw-bold"></span>'|safe)
                    }}
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="input-group input-group-lg">
            <input type="text" class="form-control" id="answer" placeholder="{{ _('Tu respuesta') }}">
            <span class="input-group-text" id="dest_unit2"></span>
        </div>
    </div>
</div>

<div class="row g-2">
    <div class="col-md-4">
        <button type="button" class="btn btn-success w-100" onclick="javascript:new_conversion()">
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-plus-circle-fill me-2" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z" />
            </svg>
            {{ _('Nueva conversión') }}
        </button>
    </div>
    <div class="col-md-4">
        <button type="button" class="btn btn-danger w-100" onclick="javascript:reset_table()">
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-clockwise me-2" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                <path
                    d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
            </svg>
            {{ _('Reiniciar tabla') }}
        </button>
    </div>
    <div class="col-md-4">
        <button type="button" class="btn btn-primary w-100" onclick="javascript:check_conversion()">
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-calculator-fill me-2" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2 .5v2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-7a.5.5 0 0 0-.5.5zm0 4v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM4 12.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM7.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM7 9.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM7.5 12a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM10.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM10 9.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM10.5 12a.5.5 0 0 0-.5.5v4a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 0-.5-.5h-1z" />
            </svg>
            {{ _('Comprobar') }}
        </button>
    </div>
</div>

<!-- Modal for messages -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Translation strings for JS
    window.translations = {
        correctTitle: "{{ _('¡Respuesta Correcta!') }}",
        correctMsg: "{{ _('¡Muy bien! Has realizado la conversión correctamente.') }}",
        incorrectTitle: "{{ _('Respuesta Incorrecta') }}",
        incorrectMsg: "{{ _('La respuesta no es correcta. Inténtalo de nuevo.') }}"
    };

    const units = {{ units| tojson }};

    document.addEventListener('DOMContentLoaded', function () {
        new_conversion();
    });

    function reset_table() {
        const collection = document.getElementsByClassName("unit_selector");
        for (let i = 0; i < collection.length; i++) {
            collection[i].selectedIndex = 0;
        }
        document.getElementById("answer").value = "";
    }

    function new_conversion() {
        const orig_unit = units[Math.floor(Math.random() * units.length)];
        const dest_unit = units[Math.floor(Math.random() * units.length)];
        const question = Math.floor(Math.random() * 10000) / 100;

        // Use comma as decimal separator for display
        document.getElementById("question").innerText = question.toString().replace(".", ",");
        document.getElementById("orig_unit").innerText = orig_unit;
        document.getElementById("dest_unit1").innerText = dest_unit;
        document.getElementById("dest_unit2").innerText = dest_unit;
        reset_table();
    }

    function check_conversion() {
        const orig_unit = document.getElementById("orig_unit").innerText;
        const dest_unit = document.getElementById("dest_unit2").innerText;

        // Replace comma with dot for calculation
        const question = parseFloat(document.getElementById("question").innerText.replace(",", "."));
        const answer = parseFloat(document.getElementById("answer").value.replace(",", "."));

        if (isNaN(answer)) {
            return; // Do nothing if answer is not a number
        }

        const conversion = question * 10 ** (units.indexOf(dest_unit) - units.indexOf(orig_unit));
        // Check with small epsilon for float comparison
        const correct = Math.abs(conversion - answer) < 1e-9;

        const modalEl = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const myModal = new bootstrap.Modal(modalEl);

        if (correct) {
            modalTitle.textContent = window.translations.correctTitle;
            modalBody.textContent = window.translations.correctMsg;
            myModal.show();

            modalEl.addEventListener('hidden.bs.modal', function () {
                new_conversion();
            }, { once: true });
        } else {
            modalTitle.textContent = window.translations.incorrectTitle;
            modalBody.textContent = window.translations.incorrectMsg;
            myModal.show();
        }
    }
</script>
{% endblock %}